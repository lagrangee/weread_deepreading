# å¾®ä¿¡è¯»ä¹¦æ·±åº¦é˜…è¯»åŠ©æ‰‹ - æ¶æ„è®¾è®¡è§„æ ¼

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº†å¾®ä¿¡è¯»ä¹¦æ·±åº¦é˜…è¯»åŠ©æ‰‹çš„æŠ€æœ¯æ¶æ„ã€è®¾è®¡åŸåˆ™å’Œå®ç°ç»†èŠ‚ã€‚

## ğŸ—ï¸ æ•´ä½“æ¶æ„

### æ¶æ„æ¨¡å¼

é‡‡ç”¨ **åˆ†å±‚æ¶æ„ + äº‹ä»¶é©±åŠ¨** çš„è®¾è®¡æ¨¡å¼ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·ç•Œé¢å±‚                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Content Script UI  â”‚  Popup UI  â”‚  Background Service  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    ä¸šåŠ¡é€»è¾‘å±‚                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  AssistantPanel  â”‚  ChatService  â”‚  SettingsService     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    é€šä¿¡å±‚                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        BridgeService  â”‚  MessageRouter  â”‚  EventUtils    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    æ•°æ®å±‚                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    Chrome Storage  â”‚  Local State  â”‚  AI API Services   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

#### 1. Content Script ç¯å¢ƒ
- **AssistantPanel**: ä¸»é¢æ¿ç»„ä»¶ï¼Œç®¡ç†UIæ˜¾ç¤ºå’Œäº¤äº’
- **ChatComponent**: èŠå¤©ç•Œé¢ç»„ä»¶ï¼Œå¤„ç†å¯¹è¯æ˜¾ç¤º
- **InteractiveComponents**: äº¤äº’ç»„ä»¶ï¼ˆæ‹–æ‹½ã€è°ƒæ•´å¤§å°ç­‰ï¼‰
- **ContentBridge**: å†…å®¹è„šæœ¬é€šä¿¡æ¡¥æ¥

#### 2. Background Script ç¯å¢ƒ
- **MessageRouter**: æ¶ˆæ¯è·¯ç”±å™¨ï¼Œå¤„ç†è·¨ç¯å¢ƒé€šä¿¡
- **ChatService**: AIèŠå¤©æœåŠ¡ï¼Œå¤„ç†AIè¯·æ±‚
- **Background**: ä¸»åå°è„šæœ¬ï¼Œåè°ƒå„ç§æœåŠ¡

#### 3. Popup ç¯å¢ƒ
- **PopupManager**: å¼¹å‡ºçª—å£ç®¡ç†å™¨
- **SettingsUI**: è®¾ç½®ç•Œé¢ç»„ä»¶

#### 4. å…±äº«æ¨¡å—
- **BridgeService**: ç»Ÿä¸€é€šä¿¡æœåŠ¡
- **SettingsService**: è®¾ç½®ç®¡ç†æœåŠ¡
- **CONFIG**: å…¨å±€é…ç½®ç®¡ç†
- **MessageTypes**: æ¶ˆæ¯ç±»å‹å®šä¹‰

## ğŸ”„ é€šä¿¡æ¶æ„

### æ¶ˆæ¯æµå‘

```mermaid
sequenceDiagram
    participant C as Content Script
    participant B as Background Script
    participant P as Popup
    participant A as AI Service

    Note over C,A: ç”¨æˆ·é€‰æ‹©æ–‡æœ¬å¹¶ç‚¹å‡»AIæŒ‰é’®
    C->>B: CHAT_REQUEST
    B->>A: HTTP Request
    A->>B: AI Response
    B->>C: CHAT_RESPONSE
    
    Note over P,C: ç”¨æˆ·ä¿®æ”¹è®¾ç½®
    P->>C: SETTINGS_CHANGED
    C->>C: Update Local State
```

### æ¶ˆæ¯ç±»å‹å®šä¹‰

```javascript
// Background æ¶ˆæ¯ç±»å‹ï¼ˆä»… AI ç›¸å…³ï¼‰
BACKGROUND_MESSAGES = {
  CHAT: {
    REQUEST: 'CHAT_REQUEST',     // AI è¯·æ±‚
    RESPONSE: 'CHAT_RESPONSE',   // AI å“åº”
    TEST_API_KEY: 'TEST_API_KEY' // æµ‹è¯• API Key
  }
}

// ç›´æ¥é€šä¿¡æ¶ˆæ¯ç±»å‹ï¼ˆPopup â†” Contentï¼‰
POPUP_MESSAGES = {
  SETTINGS: {
    GET: 'SETTINGS_GET',         // è·å–è®¾ç½®
    SET: 'SETTINGS_SET',         // ä¿å­˜è®¾ç½®
    CHANGED: 'SETTINGS_CHANGED'  // è®¾ç½®å˜æ›´é€šçŸ¥
  },
  SYSTEM: {
    STATUS: 'SYSTEM_STATUS'      // è·å–ç³»ç»ŸçŠ¶æ€
  }
}
```

## ğŸ¨ UIç»„ä»¶æ¶æ„

### ç»„ä»¶å±‚æ¬¡ç»“æ„

```
AssistantPanel (ä¸»å®¹å™¨)
â”œâ”€â”€ Header (æ ‡é¢˜æ )
â”‚   â”œâ”€â”€ BookInfo (ä¹¦ç±ä¿¡æ¯)
â”‚   â”œâ”€â”€ ProviderInfo (æœåŠ¡å•†ä¿¡æ¯)
â”‚   â””â”€â”€ ActionButtons (æ“ä½œæŒ‰é’®)
â”œâ”€â”€ ChatContainer (èŠå¤©å®¹å™¨)
â”‚   â”œâ”€â”€ MessageList (æ¶ˆæ¯åˆ—è¡¨)
â”‚   â”‚   â”œâ”€â”€ UserMessage (ç”¨æˆ·æ¶ˆæ¯)
â”‚   â”‚   â”œâ”€â”€ AIMessage (AIæ¶ˆæ¯)
â”‚   â”‚   â””â”€â”€ LoadingMessage (åŠ è½½æ¶ˆæ¯)
â”‚   â””â”€â”€ InputArea (è¾“å…¥åŒºåŸŸ)
â”‚       â”œâ”€â”€ TextInput (æ–‡æœ¬è¾“å…¥æ¡†)
â”‚       â””â”€â”€ SendButton (å‘é€æŒ‰é’®)
â”œâ”€â”€ AIButtons (AIåŠŸèƒ½æŒ‰é’®)
â”‚   â”œâ”€â”€ ExplainButton (è§£é‡ŠæŒ‰é’®)
â”‚   â”œâ”€â”€ DigestButton (æ¶ˆåŒ–æŒ‰é’®)
â”‚   â””â”€â”€ AnalyzeButton (å…¼å¬æŒ‰é’®)
â””â”€â”€ InteractiveElements (äº¤äº’å…ƒç´ )
    â”œâ”€â”€ DragHandle (æ‹–æ‹½æ‰‹æŸ„)
    â”œâ”€â”€ ResizeHandle (è°ƒæ•´å¤§å°æ‰‹æŸ„)
    â””â”€â”€ ModeToggle (æ¨¡å¼åˆ‡æ¢)
```

### ç»„ä»¶çŠ¶æ€ç®¡ç†

```javascript
// ç»„ä»¶çŠ¶æ€ç»“æ„
const ComponentState = {
  ui: {
    panel: {
      isShowing: boolean,
      mode: 'floating' | 'inline',
      position: { x: number, y: number },
      size: { width: number, height: number }
    },
    buttons: {
      explain: { loading: boolean, disabled: boolean },
      digest: { loading: boolean, disabled: boolean },
      analyze: { loading: boolean, disabled: boolean }
    },
    chat: {
      messages: Array<Message>,
      isLoading: boolean,
      inputValue: string
    }
  },
  user: {
    currentProvider: string,
    apiKeys: Object<string, string>,
    preferences: Object
  },
  system: {
    bookName: string,
    authorName: string,
    selectedText: string
  }
}
```

## ğŸ”§ æœåŠ¡å±‚è®¾è®¡

### ChatService (AIèŠå¤©æœåŠ¡)

```javascript
class ChatService {
  // æ ¸å¿ƒæ–¹æ³•
  async sendMessage(options)      // å‘é€AIè¯·æ±‚
  async testApiConnection(provider, apiKey)  // æµ‹è¯•APIè¿æ¥
  buildPrompts(action, text, book, author)   // æ„å»ºæç¤ºè¯
  
  // ç§æœ‰æ–¹æ³•
  #sendAIRequest(provider, apiKey, systemPrompt, userPrompt)
  #getApiKey(provider)
  #buildPrompts(action, text, book, author, context)
}
```

### BridgeService (é€šä¿¡æ¡¥æ¥æœåŠ¡)

```javascript
class BridgeService {
  // æ ¸å¿ƒæ–¹æ³•
  async sendMessage(type, data, options)  // å‘é€æ¶ˆæ¯
  on(type, handler)                       // æ³¨å†Œå¤„ç†å™¨
  async broadcast(type, data)             // å¹¿æ’­æ¶ˆæ¯
  
  // ç§æœ‰æ–¹æ³•
  #handleMessage(message, sender, sendResponse)
  #init()
  destroy()
}
```

### SettingsService (è®¾ç½®ç®¡ç†æœåŠ¡)

```javascript
class SettingsService {
  // API Keys ç®¡ç†
  async saveAPIKeys(apiKeys)
  async loadAPIKeys()
  
  // æœåŠ¡å•†ç®¡ç†
  async saveProvider(provider)
  async loadProvider()
  
  // UIçŠ¶æ€ç®¡ç†
  async saveFloating(floating)
  async loadFloating()
  async saveMode(mode)
  async loadMode()
  
  // ç§æœ‰æ–¹æ³•
  #saveSettings(key, value)
  #loadSettings(key)
}
```

## ğŸ“Š æ•°æ®æµè®¾è®¡

### æ•°æ®æµå‘

```mermaid
flowchart TD
    A[ç”¨æˆ·é€‰æ‹©æ–‡æœ¬] --> B[è§¦å‘AIæŒ‰é’®]
    B --> C[æ›´æ–°æŒ‰é’®çŠ¶æ€]
    C --> D[å‘é€AIè¯·æ±‚]
    D --> E[Backgroundå¤„ç†]
    E --> F[è°ƒç”¨AI API]
    F --> G[è¿”å›AIå“åº”]
    G --> H[æ›´æ–°èŠå¤©ç•Œé¢]
    H --> I[æ¢å¤æŒ‰é’®çŠ¶æ€]
```

### çŠ¶æ€åŒæ­¥æœºåˆ¶

```javascript
// çŠ¶æ€åŒæ­¥æµç¨‹
1. ç”¨æˆ·æ“ä½œ â†’ æœ¬åœ°çŠ¶æ€æ›´æ–°
2. æœ¬åœ°çŠ¶æ€æ›´æ–° â†’ è§¦å‘UIé‡æ¸²æŸ“
3. éœ€è¦æŒä¹…åŒ–çš„çŠ¶æ€ â†’ ä¿å­˜åˆ°Chrome Storage
4. éœ€è¦è·¨ç¯å¢ƒåŒæ­¥çš„çŠ¶æ€ â†’ å‘é€æ¶ˆæ¯é€šçŸ¥å…¶ä»–ç¯å¢ƒ
```

## ğŸ”’ å®‰å…¨è®¾è®¡

### API Key å®‰å…¨å­˜å‚¨

```javascript
// API Key å­˜å‚¨ç­–ç•¥
const SecurityStrategy = {
  storage: 'chrome.storage.local',  // ä½¿ç”¨æœ¬åœ°å­˜å‚¨
  encryption: false,                // Chromeå·²æä¾›åŠ å¯†
  access: 'background-only',        // ä»…åå°è„šæœ¬è®¿é—®
  transmission: 'never'             // æ°¸ä¸ä¼ è¾“åˆ°å¤–éƒ¨
}
```

### æƒé™æœ€å°åŒ–åŸåˆ™

```json
{
  "permissions": [
    "storage"           // ä»…å­˜å‚¨æƒé™
  ],
  "host_permissions": [
    "https://weread.qq.com/*"  // ä»…å¾®ä¿¡è¯»ä¹¦åŸŸå
  ]
}
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. ç»„ä»¶æ‡’åŠ è½½

```javascript
// æŒ‰éœ€åŠ è½½ç»„ä»¶
const HelpModal = lazy(() => import('./help-modal/help-modal.js'));
const ChatComponent = lazy(() => import('./chat/chat-component.js'));
```

### 2. æ¶ˆæ¯é˜²æŠ–

```javascript
// AIè¯·æ±‚é˜²æŠ–
const debouncedAIRequest = debounce(sendAIRequest, 300);
```

### 3. ç¼“å­˜ç­–ç•¥

```javascript
// å¤šå±‚ç¼“å­˜
const CacheStrategy = {
  memory: new Map(),           // å†…å­˜ç¼“å­˜ï¼ˆä¼šè¯çº§ï¼‰
  storage: chrome.storage,     // æŒä¹…åŒ–ç¼“å­˜
  ttl: 5 * 60 * 1000         // 5åˆ†é’Ÿè¿‡æœŸ
}
```

### 4. èµ„æºä¼˜åŒ–

```javascript
// Webpackä¼˜åŒ–é…ç½®
const optimization = {
  splitChunks: {
    cacheGroups: {
      vendor: {
        test: /[\\/]node_modules[\\/]/,
        name: 'vendors',
        chunks: 'all'
      }
    }
  }
}
```

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### æµ‹è¯•å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           E2E æµ‹è¯•                   â”‚  â† Chrome Extension é›†æˆæµ‹è¯•
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           é›†æˆæµ‹è¯•                   â”‚  â† ç»„ä»¶é—´äº¤äº’æµ‹è¯•
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           å•å…ƒæµ‹è¯•                   â”‚  â† å•ä¸ªå‡½æ•°/ç±»æµ‹è¯•
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æµ‹è¯•è¦†ç›–èŒƒå›´

1. **å•å…ƒæµ‹è¯•**
   - å·¥å…·å‡½æ•°æµ‹è¯•
   - æœåŠ¡ç±»æ–¹æ³•æµ‹è¯•
   - ç»„ä»¶é€»è¾‘æµ‹è¯•

2. **é›†æˆæµ‹è¯•**
   - é€šä¿¡æœºåˆ¶æµ‹è¯•
   - çŠ¶æ€ç®¡ç†æµ‹è¯•
   - UIäº¤äº’æµ‹è¯•

3. **E2Eæµ‹è¯•**
   - å®Œæ•´ç”¨æˆ·æµç¨‹æµ‹è¯•
   - è·¨ç¯å¢ƒé€šä¿¡æµ‹è¯•
   - é”™è¯¯å¤„ç†æµ‹è¯•

## ğŸ“ˆ ç›‘æ§å’Œè°ƒè¯•

### æ—¥å¿—ç³»ç»Ÿ

```javascript
// ç»Ÿä¸€æ—¥å¿—æ ¼å¼
const LogFormat = {
  prefix: CONFIG.LOG_PREFIX,
  level: 'info' | 'warn' | 'error',
  context: {
    component: string,
    action: string,
    data: object
  }
}
```

### æ€§èƒ½ç›‘æ§

```javascript
// æ€§èƒ½æŒ‡æ ‡æ”¶é›†
const Metrics = {
  messageProcessingTime: number,
  aiResponseTime: number,
  uiRenderTime: number,
  memoryUsage: number
}
```

## ğŸ”® æ‰©å±•æ€§è®¾è®¡

### æ’ä»¶åŒ–æ¶æ„é¢„ç•™

```javascript
// æ’ä»¶æ¥å£è®¾è®¡
interface Plugin {
  name: string;
  version: string;
  init(context: PluginContext): void;
  destroy(): void;
  
  // ç”Ÿå‘½å‘¨æœŸé’©å­
  onBeforeAIRequest?(data: any): any;
  onAfterAIResponse?(response: any): any;
  onUIRender?(element: HTMLElement): void;
}
```

### ä¸»é¢˜ç³»ç»Ÿé¢„ç•™

```javascript
// ä¸»é¢˜æ¥å£è®¾è®¡
interface Theme {
  name: string;
  colors: ColorPalette;
  fonts: FontConfig;
  spacing: SpacingConfig;
  
  apply(): void;
  remove(): void;
}
```

## ğŸ“‹ éƒ¨ç½²å’Œå‘å¸ƒ

### æ„å»ºæµç¨‹

```mermaid
flowchart LR
    A[æºä»£ç ] --> B[Webpackæ„å»º]
    B --> C[ä»£ç å‹ç¼©]
    C --> D[èµ„æºä¼˜åŒ–]
    D --> E[ç”Ÿæˆdistç›®å½•]
    E --> F[æ‰“åŒ…zipæ–‡ä»¶]
    F --> G[Chrome Web Store]
```

### ç‰ˆæœ¬ç®¡ç†

```javascript
// ç‰ˆæœ¬å·è§„èŒƒï¼šä¸»ç‰ˆæœ¬.æ¬¡ç‰ˆæœ¬.ä¿®è®¢ç‰ˆæœ¬
const VersionStrategy = {
  major: 'ä¸å…¼å®¹çš„APIä¿®æ”¹',
  minor: 'å‘ä¸‹å…¼å®¹çš„åŠŸèƒ½æ€§æ–°å¢',
  patch: 'å‘ä¸‹å…¼å®¹çš„é—®é¢˜ä¿®æ­£'
}
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [Chrome Extension Manifest V3](https://developer.chrome.com/docs/extensions/mv3/)
- [Chrome Extension Architecture](https://developer.chrome.com/docs/extensions/mv3/architecture-overview/)
- [Web Components Best Practices](https://developers.google.com/web/fundamentals/web-components/best-practices) 